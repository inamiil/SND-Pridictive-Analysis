<!DOCTYPE html>
<html>
<head>
    <title>Sales Dashboard</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            background-color: #f8f9fa;
        }
        .chart-container {
            margin-top: 20px;
        }
    </style>
</head>
<body>
<div class="container mt-5">
    <h2 class="text-center mb-4">Sales Dashboard</h2>

    <!-- Tabs -->
    <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <a class="nav-link active" id="division-tab" data-bs-toggle="tab" href="#division" role="tab">Division</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" id="distributor-tab" data-bs-toggle="tab" href="#distributor" role="tab">Distributor</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" id="sku-tab" data-bs-toggle="tab" href="#sku" role="tab">SKU</a>
        </li>
    </ul>

    <div class="tab-content mt-4" id="dashboardTabsContent">
        <!-- Division -->
        <div class="tab-pane fade show active" id="division" role="tabpanel">
            <select id="divisionDropdown" class="form-select mb-3">
                <option value="region-sales">Region Sales</option>
                <option value="division-sales">Division Sales</option>
                <option value="yearly-sales-by-division">Yearly Sales by Division</option>
                <option value="monthly-sales-combined">Monthly Sales (Combined)</option>
                <option value="monthly-sales-by-division">Monthly Sales by Division</option>
            </select>
            <canvas id="divisionChart"></canvas>
        </div>

        <!-- Distributor -->
        <div class="tab-pane fade" id="distributor" role="tabpanel">
            <select id="distributorDropdown" class="form-select mb-3">
                <option value="top-distributors">Top Distributors</option>
                <option value="yearly-sales-top-distributors">Yearly Sales (Top)</option>
                <option value="distributor-division-heatmap">Division Heatmap</option>
                <option value="stacked-sales-distributor-division">Stacked Sales by Division</option>
                <option value="distributor-type-sales">Sales by Distributor Type</option>
            </select>
            <canvas id="distributorChart"></canvas>
        </div>

        <!-- SKU -->
        <div class="tab-pane fade" id="sku" role="tabpanel">
            <select id="skuDropdown" class="form-select mb-3">
                <option value="top-skus">Top SKUs</option>
                <option value="pack-size-sales-by-division">Pack Size by Division</option>
                <option value="top-brands-by-division">Top Brands by Division</option>
                <option value="brand-packsize-combos">Brand-Pack Size Combos</option>
                <option value="top-flavours-by-division">Top Flavours</option>
            </select>
            <canvas id="skuChart"></canvas>
        </div>
    </div>
</div>

<!-- JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let divisionChart, distributorChart, skuChart;

    function renderGroupedChart(ctx, chartRef, data, groupBy, valueKey) {
        if (chartRef) chartRef.destroy();

        const divisions = [...new Set(data.map(d => d.DIVISION))]; // e.g., ['CANDYLAND', 'BISCONNI']
        const labels = [...new Set(data.map(d => d[groupBy]))];

        const datasets = divisions.map((div, i) => ({
            label: div,
            data: labels.map(lbl => {
                const found = data.find(d => d[groupBy] === lbl && d.DIVISION === div);
                return found ? found[valueKey] : 0;
            }),
            backgroundColor: i === 0 ? '#007bff' : '#28a745'
        }));

        return new Chart(ctx, {
            type: 'bar',
            data: { labels, datasets },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: value => value >= 1e6 ? value / 1e6 + 'M' : value / 1e3 + 'K'
                        }
                    }
                }
            }
        });
    }

    function renderSingleChart(ctx, chartRef, data, labelKey, valueKey) {
        if (chartRef) chartRef.destroy();

        return new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.map(d => d[labelKey]),
                datasets: [{
                    label: valueKey,
                    data: data.map(d => d[valueKey]),
                    backgroundColor: '#7851A9'
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: value => value >= 1e6 ? value / 1e6 + 'M' : value / 1e3 + 'K'
                        }
                    }
                }
            }
        });
    }

    async function loadChart(dropdownId, chartRef, canvasId) {
        const val = document.getElementById(dropdownId).value;
        const res = await fetch(`/api/${val}`);
        const data = await res.json();

        let labelKey = 'REGION';
        if (val.includes('division')) labelKey = 'DIVISION';
        if (val.includes('monthly')) labelKey = 'MONTH';
        if (val.includes('yearly')) labelKey = 'YEAR';
        if (val.includes('sku')) labelKey = 'SKU_LDESC';
        if (val.includes('pack-size')) labelKey = 'PACK_SIZE';
        if (val.includes('brand')) labelKey = 'BRAND';
        if (val.includes('flavour')) labelKey = 'FLAVOUR';
        if (val.includes('distributor-type')) labelKey = 'DISTRIBUTOR_TYPE';
        if (val.includes('distributor')) labelKey = 'DISTRIBUTOR_NAME';

        const hasDivision = data.length > 0 && 'DIVISION' in data[0];

        const ctx = document.getElementById(canvasId);
        return hasDivision
            ? renderGroupedChart(ctx, chartRef, data, labelKey, 'NET_SALE_AMOUNT')
            : renderSingleChart(ctx, chartRef, data, labelKey, 'NET_SALE_AMOUNT');
    }

    // === Dropdown Listeners ===
    document.getElementById('divisionDropdown').addEventListener('change', async () => {
        divisionChart = await loadChart('divisionDropdown', divisionChart, 'divisionChart');
    });

    document.getElementById('distributorDropdown').addEventListener('change', async () => {
        distributorChart = await loadChart('distributorDropdown', distributorChart, 'distributorChart');
    });

    document.getElementById('skuDropdown').addEventListener('change', async () => {
        skuChart = await loadChart('skuDropdown', skuChart, 'skuChart');
    });

    // === Tab Triggers ===
    document.querySelectorAll('a[data-bs-toggle="tab"]').forEach(tab => {
        tab.addEventListener('shown.bs.tab', function (e) {
            const tabId = e.target.getAttribute('href').substring(1);
            if (tabId === 'division') document.getElementById('divisionDropdown').dispatchEvent(new Event('change'));
            if (tabId === 'distributor') document.getElementById('distributorDropdown').dispatchEvent(new Event('change'));
            if (tabId === 'sku') document.getElementById('skuDropdown').dispatchEvent(new Event('change'));
        });
    });

    // === Load Initial View ===
    window.onload = () => {
        document.getElementById('divisionDropdown').dispatchEvent(new Event('change'));
    };
</script>

</body>
</html>
