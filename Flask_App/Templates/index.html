<!DOCTYPE html>
<html>
<head>
    <title>Sales Dashboard</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f8f9fa; }
        .chart-container { margin-top: 20px; }
        .region-chart { width: 100%; max-width: 500px; margin: 1rem auto; }
    </style>
</head>
<body>
<div class="container mt-5">
    <h2 class="text-center mb-4">Sales Dashboard</h2>

    <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
        <li class="nav-item"><a class="nav-link active" id="division-tab" data-bs-toggle="tab" href="#division" role="tab">Division</a></li>
        <li class="nav-item"><a class="nav-link" id="distributor-tab" data-bs-toggle="tab" href="#distributor" role="tab">Distributor</a></li>
        <li class="nav-item"><a class="nav-link" id="sku-tab" data-bs-toggle="tab" href="#sku" role="tab">SKU</a></li>
        <li class="nav-item"><a class="nav-link" id="brands-tab" data-bs-toggle="tab" href="#brands" role="tab">Brands</a></li>
        <li class="nav-item"><a class="nav-link" id="DailySales-tab" data-bs-toggle="tab" href="#DailySales" role="tab">DailySales</a></li>        
    </ul>

    <div class="tab-content mt-4" id="dashboardTabsContent">
        <div class="tab-pane fade show active" id="division" role="tabpanel">
            <select id="divisionDropdown" class="form-select mb-3">
                <option value="region-sales">Region Sales</option>
                <option value="division-sales">Division Sales</option>
                <option value="yearly-sales-by-division">Yearly Sales by Division</option>
                <option value="monthly-sales-combined">Monthly Sales (Combined)</option>
                <option value="monthly-sales-by-division">Monthly Sales by Division</option>
            </select>
            <canvas id="divisionChart"></canvas>
        </div>
        <div class="tab-pane fade" id="distributor" role="tabpanel">
            <select id="distributorDropdown" class="form-select mb-3">
                <option value="top-distributors">Top Distributors</option>
                <option value="yearly-sales-top-distributors">Yearly Sales (Top)</option>
                <option value="distributor-division-heatmap">Division Heatmap</option>
                <option value="stacked-sales-distributor-division">Stacked Sales by Division</option>
                <option value="distributor-type-sales">Sales by Distributor Type</option>
            </select>
            <canvas id="distributorChart"></canvas>
        </div>
        <div class="tab-pane fade" id="sku" role="tabpanel">
            <select id="skuDropdown" class="form-select mb-3">
                <option value="top-skus">Top SKUs</option>
                <option value="pack-size-sales-by-division">Pack Size by Division</option>
                <option value="top-brands-by-division">Top Brands by Division</option>
                <option value="brand-packsize-combos">Brand-Pack Size Combos</option>
                <option value="top-flavours-by-division">Top Flavours</option>
            </select>
            <canvas id="skuChart"></canvas>
        </div>
        <div class="tab-pane fade" id="brands" role="tabpanel">
            <h5>National Top 3 Brands</h5>
            <canvas id="nationalBrandsChart"></canvas>
            <h5 class="mt-5">Top 3 Brands Per Region</h5>
            <div id="regionalBrandCharts" class="row"></div>
        </div>
        <div class="tab-pane fade" id="DailySales" role="tabpanel">
            <div class="row mb-3">
                <div class="col-md-3">
                    <select id="dailyDivision" class="form-select">
                        <option value="BISCONNI">BISCONNI</option>
                        <option value="CANDYLAND">CANDYLAND</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select id="dailyTerritory" class="form-select">
                        <option value="KARACHI">KARACHI</option>
                        <option value="LAHORE">LAHORE</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select id="dailyYear" class="form-select">
                        <option value="2024">2024</option>
                        <option value="2025">2025</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select id="dailyMonth" class="form-select">
                        <option value="1">January</option>
                        <option value="2">February</option>
                        <option value="3">March</option>
                        <option value="4">April</option>
                        <option value="5">May</option>
                        <option value="6">June</option>
                        <option value="7">July</option>
                        <option value="8">August</option>
                        <option value="9">September</option>
                        <option value="10">October</option>
                        <option value="11">November</option>
                        <option value="12">December</option>
                    </select>
                </div>
            </div>

            <div id="loadingMessage" class="text-center text-muted mb-3" style="display:none;">Loading data... Please wait.</div>
            <canvas id="DailySalesChart"></canvas>

            <div class="row mt-4">
                <div class="col-md-6">
                    <h6>🔼 Top 3 Sales Days</h6>
                    <div id="topSalesDays"></div>
                </div>
                <div class="col-md-6">
                    <h6>🔽 Bottom 3 Sales Days</h6>
                    <div id="bottomSalesDays"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let divisionChart, distributorChart, skuChart, nationalBrandsChart;
    const regionalBrandCharts = {};

    function renderGroupedChart(ctx, chartRef, data, groupBy, valueKey) {
        if (chartRef) chartRef.destroy();
        const groups = [...new Set(data.map(d => d.DIVISION))];
        const labels = [...new Set(data.map(d => d[groupBy]))];

        const datasets = groups.map((g, i) => ({
            label: g,
            data: labels.map(lbl => {
                const found = data.find(d => d[groupBy] === lbl && d.DIVISION === g);
                return found ? found[valueKey] : 0;
            }),
            backgroundColor: i === 0 ? '#007bff' : '#28a745'
        }));

        return new Chart(ctx, {
            type: 'bar',
            data: { labels, datasets },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: value => value >= 1e6 ? value / 1e6 + 'M' : value / 1e3 + 'K'
                        }
                    }
                }
            }
        });
    }

    function renderSingleChart(ctx, chartRef, data, labelKey, valueKey, type='bar') {
        if (chartRef) chartRef.destroy();

        return new Chart(ctx, {
            type,
            data: {
                labels: data.map(d => d[labelKey]),
                datasets: [{
                    label: valueKey,
                    data: data.map(d => d[valueKey]),
                    backgroundColor: '#7851A9',
                    borderColor: '#5b3d91',
                    fill: false
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: value => value >= 1e6 ? value / 1e6 + 'M' : value / 1e3 + 'K'
                        }
                    }
                }
            }
        });
    }

    async function loadChart(dropdownId, chartRef, canvasId) {
        const val = document.getElementById(dropdownId).value;
        const res = await fetch(`/api/${val}`);
        const data = await res.json();

        let labelKey = 'REGION';
        if (val.includes('division')) labelKey = 'DIVISION';
        if (val.includes('monthly')) labelKey = 'MONTH';
        if (val.includes('yearly')) labelKey = 'YEAR';
        if (val.includes('sku')) labelKey = 'SKU_LDESC';
        if (val.includes('pack-size')) labelKey = 'PACK_SIZE';
        if (val.includes('brand')) labelKey = 'BRAND';
        if (val.includes('flavour')) labelKey = 'FLAVOUR';
        if (val.includes('distributor-type')) labelKey = 'DISTRIBUTOR_TYPE';
        if (val.includes('distributor')) labelKey = 'DISTRIBUTOR_NAME';

        const hasDivision = data.length > 0 && 'DIVISION' in data[0];
        const ctx = document.getElementById(canvasId);
        return hasDivision
            ? renderGroupedChart(ctx, chartRef, data, labelKey, 'NET_SALE_AMOUNT')
            : renderSingleChart(ctx, chartRef, data, labelKey, 'NET_SALE_AMOUNT');
    }

    async function loadNationalBrandsChart() {
        const res = await fetch('/api/national-top-brands');
        let data = await res.json();

        // 👇 Patch YEAR_MONTH field here
        data = data.map(d => ({
            ...d,
            YEAR_MONTH: `${d.YEAR}-${String(d.MONTH).padStart(2, '0')}`
        }));

        const ctx = document.getElementById('nationalBrandsChart');
        const labelKey = 'YEAR_MONTH';
        const datasets = [...new Set(data.map(d => d.BRAND))].map((brand, i) => ({
            label: brand,
            data: data.filter(d => d.BRAND === brand).map(d => d.MONTHLY_SALES),
            backgroundColor: ['#007bff', '#28a745', '#ffc107'][i],
            borderColor: ['#007bff', '#28a745', '#ffc107'][i],
            fill: false
        }));

        const labels = [...new Set(data.map(d => d[labelKey]))];

        if (nationalBrandsChart) nationalBrandsChart.destroy();
        nationalBrandsChart = new Chart(ctx, {
            type: 'line',
            data: { labels, datasets },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'National Top 3 Brands Monthly Trend'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: value => value >= 1e6 ? value / 1e6 + 'M' : value / 1e3 + 'K'
                        }
                    }
                }
            }
        });
    }

    async function loadRegionalBrandCharts() {
        console.log("📡 Calling /api/daily-sales");  // <== Add this at top
        const res = await fetch('/api/regional-top-brands');
        let data = await res.json();

        // 👇 Patch YEAR_MONTH field here
        data = data.map(d => ({
            ...d,
            YEAR_MONTH: `${d.YEAR}-${String(d.MONTH).padStart(2, '0')}`
        }));

        const container = document.getElementById('regionalBrandCharts');
        container.innerHTML = '';
        const regions = [...new Set(data.map(d => d.REGION))];

        regions.forEach(region => {
            const canvas = document.createElement('canvas');
            canvas.className = 'region-chart col-md-6';
            container.appendChild(canvas);

            const regionData = data.filter(d => d.REGION === region);
            const labels = [...new Set(regionData.map(d => d.YEAR_MONTH))];
            const brands = [...new Set(regionData.map(d => d.BRAND))];

            const datasets = brands.map((brand, i) => ({
                label: brand,
                data: labels.map(lbl => {
                    const found = regionData.find(d => d.YEAR_MONTH === lbl && d.BRAND === brand);
                    return found ? found.MONTHLY_SALES : 0;
                }),
                backgroundColor: ['#e6194b', '#3cb44b', '#ffe119'][i % 3]
            }));

            new Chart(canvas.getContext('2d'), {
                type: 'bar',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: `Region: ${region}`
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: value => value >= 1e6 ? value / 1e6 + 'M' : value / 1e3 + 'K'
                            }
                        }
                    }
                }
            });
        });
    }

    async function fetchAndRenderDailySales() {
        const division = document.getElementById('dailyDivision').value;
        const territory = document.getElementById('dailyTerritory').value;
        const year = document.getElementById('dailyYear').value;
        const month = document.getElementById('dailyMonth').value;

        const loadingDiv = document.getElementById('loadingMessage');
        loadingDiv.style.display = 'block';

        try {
            const res = await fetch(`/api/daily-sales?division=${division}&territory=${territory}&year=${year}&month=${month}`);
            const data = await res.json();

            const labels = data.data.map(d => `Day ${d.DAY}`);
            const values = data.data.map(d => d.NET_SALE_AMOUNT_M);

            const ctx = document.getElementById('DailySalesChart').getContext('2d');
            if (window.DailySalesChart && typeof window.DailySalesChart.destroy === 'function') {window.DailySalesChart.destroy();}

            window.DailySalesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'Daily Sales (Millions)',
                        data: values,
                        borderColor: '#3367D6',
                        backgroundColor: '#4285F4',
                        tension: 0.3,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: v => v >= 1 ? v + 'M' : v
                            }
                        }
                    }
                }
            });

            document.getElementById('topSalesDays').innerHTML =
                data.top_3.map(d => `Day ${d.DAY}: ${d.NET_SALE_AMOUNT.toLocaleString()}`).join('<br>');

            document.getElementById('bottomSalesDays').innerHTML =
                data.bottom_3.map(d => `Day ${d.DAY}: ${d.NET_SALE_AMOUNT.toLocaleString()}`).join('<br>');
        } catch (err) {
            console.error('❌ Error loading sales data:', err);
            alert('Failed to load sales data: ' + err.message);
        } finally {
            loadingDiv.style.display = 'none';
        }
    }
    document.getElementById('divisionDropdown').addEventListener('change', async () => {
        divisionChart = await loadChart('divisionDropdown', divisionChart, 'divisionChart');
    });
    document.getElementById('distributorDropdown').addEventListener('change', async () => {
        distributorChart = await loadChart('distributorDropdown', distributorChart, 'distributorChart');
    });
    document.getElementById('skuDropdown').addEventListener('change', async () => {
        skuChart = await loadChart('skuDropdown', skuChart, 'skuChart');
    });
    document.getElementById('brands-tab').addEventListener('click', async () => {
        await loadNationalBrandsChart();
        await loadRegionalBrandCharts();
    });


    window.onload = () => {
        document.getElementById('divisionDropdown').dispatchEvent(new Event('change'));

        const tabList = document.getElementById('dashboardTabs');
        if (tabList) {
            tabList.addEventListener('click', async (e) => {
                const tab = e.target.closest('a');
                if (tab && tab.id === 'DailySales-tab') {
                    console.log("🟣 DailySales tab clicked");
                    await fetchAndRenderDailySales();
                }
            });
        }

        // Attach other dropdown listeners too (safely inside onload)
        ['dailyDivision', 'dailyTerritory', 'dailyYear', 'dailyMonth'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.addEventListener('change', fetchAndRenderDailySales);
        });

        // Trigger default chart
        document.getElementById('divisionDropdown').dispatchEvent(new Event('change'));
    };
</script>
</body>
</html>
